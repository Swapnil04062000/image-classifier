name: CI/CD - Build Push & Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  FASTAPI_REPO: ${{ secrets.FASTAPI_REPO }}
  TF_REPO: ${{ secrets.TF_REPO }}
  MODEL_BUCKET: ${{ secrets.MODEL_BUCKET }}
  TASK_FAMILY: ${{ secrets.TASK_FAMILY }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
  FASTAPI_CONTAINER_NAME: ${{ secrets.FASTAPI_CONTAINER_NAME }}
  TF_CONTAINER_NAME: ${{ secrets.TF_CONTAINER_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Debug identity (for troubleshooting)
      run: |
        echo "Caller identity:"
        aws sts get-caller-identity

    - name: Ensure ECR repositories exist
      run: |
        set -e
        echo "Checking/creating ECR repositories..."
        aws ecr describe-repositories --repository-names "${FASTAPI_REPO}" --region ${AWS_REGION} >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "${FASTAPI_REPO}" --region ${AWS_REGION}
        aws ecr describe-repositories --repository-names "${TF_REPO}" --region ${AWS_REGION} >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "${TF_REPO}" --region ${AWS_REGION}
      shell: bash

    - name: Log in to ECR (Docker)
      uses: docker/login-action@v2
      with:
        registry: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
        username: AWS
        password: ${{ steps.configure-aws-credentials.outputs.secret_access_key }} # fallback; configure-aws-credentials sets creds in env

    - name: Build & push FastAPI image (multi-tag)
      id: fastapi_build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.fastapi
        push: true
        platforms: linux/amd64
        tags: |
          ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.FASTAPI_REPO }}:latest
          ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.FASTAPI_REPO }}:${{ github.sha }}

    - name: Prepare saved_models for TF image build (if missing, try S3)
      id: prepare_model
      run: |
        set -e
        if [ -d "saved_models/image_classifier" ]; then
          echo "Local saved_models found; will use it."
        else
          echo "Local saved_models not found. Attempting to sync from S3 s3://${MODEL_BUCKET}/image_classifier"
          aws s3 ls "s3://${MODEL_BUCKET}/image_classifier/" --region ${AWS_REGION} || (echo "No model in S3 at s3://${MODEL_BUCKET}/image_classifier" && exit 1)
          mkdir -p saved_models
          aws s3 sync "s3://${MODEL_BUCKET}/image_classifier" saved_models/image_classifier --region ${AWS_REGION}
          echo "Model synced from S3 to saved_models/image_classifier"
        fi
      shell: bash

    - name: Build & push TF Serving image (multi-tag)
      id: tf_build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.tf_serving
        push: true
        platforms: linux/amd64
        tags: |
          ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.TF_REPO }}:latest
          ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.TF_REPO }}:${{ github.sha }}

    - name: Get current task definition JSON
      id: get_td
      run: |
        aws ecs describe-task-definition --task-definition "${TASK_FAMILY}" --region ${AWS_REGION} > td-full.json
        jq '.taskDefinition' td-full.json > td.json
        echo "::set-output name=tdfile::td.json"
      shell: bash

    - name: Create new task definition registration payload
      id: prepare_td
      run: |
        set -e
        TD="td.json"
        REG="taskdef-register.json"

        # Build a skeleton payload suitable for register-task-definition with necessary fields
        jq '{
          family: .family,
          taskRoleArn: .taskRoleArn,
          executionRoleArn: .executionRoleArn,
          networkMode: .networkMode,
          containerDefinitions: .containerDefinitions,
          volumes: .volumes,
          placementConstraints: .placementConstraints,
          requiresCompatibilities: .requiresCompatibilities,
          cpu: .cpu,
          memory: .memory
        }' $TD > $REG

        # Update container image URIs for FastAPI & TF containers (match by container name)
        FASTAPI_IMG="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${FASTAPI_REPO}:latest"
        TF_IMG="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${TF_REPO}:latest"

        # Replace image for the containers with matching names
        jq --arg fname "${FASTAPI_CONTAINER_NAME}" --arg fimg "${FASTAPI_IMG}" \
           --arg tname "${TF_CONTAINER_NAME}" --arg timg "${TF_IMG}" \
           '(.containerDefinitions[] | select(.name == $fname) ).image = $fimg |
            (.containerDefinitions[] | select(.name == $tname) ).image = $timg' \
           $REG > ${REG}.tmp && mv ${REG}.tmp $REG

        echo "Prepared taskdef payload:"
        jq '.' $REG
        echo "::set-output name=registerfile::${REG}"
      shell: bash

    - name: Register new task definition
      id: register_td
      run: |
        REG="taskdef-register.json"
        aws ecs register-task-definition --cli-input-json file://$REG --region ${AWS_REGION} > register-out.json
        echo "Registered new task definition:"
        jq '.taskDefinition.taskDefinitionArn' register-out.json
      shell: bash

    - name: Update ECS service to force new deployment
      run: |
        aws ecs update-service --cluster ${ECS_CLUSTER} --service ${ECS_SERVICE} --force-new-deployment --region ${AWS_REGION}
        echo "Triggered service update."
      shell: bash

    - name: Wait for deployment to stabilize (poll)
      run: |
        set -e
        CLUSTER="${ECS_CLUSTER}"
        SERVICE="${ECS_SERVICE}"
        REGION="${AWS_REGION}"
        echo "Waiting for service to have runningCount >= desiredCount ..."
        for i in {1..40}; do
          out=$(aws ecs describe-services --cluster "$CLUSTER" --services "$SERVICE" --region "$REGION" --query "services[0].[desiredCount,runningCount]" --output text)
          desired=$(echo $out | awk '{print $1}')
          running=$(echo $out | awk '{print $2}')
          echo "desired=$desired running=$running"
          if [ "$desired" != "" ] && [ "$running" != "" ] && [ "$running" -ge "$desired" ]; then
            echo "Deployment looks healthy."
            exit 0
          fi
          sleep 10
        done
        echo "Timed out waiting for deployment to stabilize."
        exit 1
      shell: bash


